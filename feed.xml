<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.7">Jekyll</generator><link href="https://jadia.dev/feed.xml" rel="self" type="application/atom+xml" /><link href="https://jadia.dev/" rel="alternate" type="text/html" /><updated>2021-06-02T06:59:07+00:00</updated><id>https://jadia.dev/feed.xml</id><title type="html">Nitish Jadia</title><subtitle>A blog where I publish posts about my learnings on software development, my thoughts, my ideas and topics that I find interesting.</subtitle><author><name>Nitish Jadia</name><email>nitish@jadia.dev</email></author><entry><title type="html">Encrypt and backup personal files to an object storage</title><link href="https://jadia.dev/2021/05/16/Encrypt_and_backup_files_to_object_storage" rel="alternate" type="text/html" title="Encrypt and backup personal files to an object storage" /><published>2021-05-16T14:51:00+00:00</published><updated>2021-05-16T14:51:00+00:00</updated><id>https://jadia.dev/2021/05/16/Encrypt_and_backup_files_to_object_storage</id><content type="html" xml:base="https://jadia.dev/2021/05/16/Encrypt_and_backup_files_to_object_storage">&lt;p&gt;I feel that cloud backups are expensive, look at Dropbox, Google Drive, OneDrive, etc. BlackBlaze B2, &lt;em&gt;seems&lt;/em&gt; to be a good for long term backups where you upload and forget, download only when we are required.&lt;br /&gt;
It‚Äôs important to have your personal files encrypted when stored on the cloud, you never know about another &lt;a href=&quot;https://en.wikipedia.org/wiki/ICloud_leaks_of_celebrity_photos&quot;&gt;iCloud hack&lt;/a&gt;.&lt;/p&gt;

&lt;h4 id=&quot;install-gocryptfs-and-rclone&quot;&gt;Install GocryptFS and rClone&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; gocryptfs
curl https://rclone.org/install.sh | &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;set-up-object-storage&quot;&gt;Set up object storage&lt;/h4&gt;

&lt;p&gt;Register at &lt;a href=&quot;https://www.backblaze.com/b2/cloud-storage.html&quot;&gt;https://www.backblaze.com/b2/cloud-storage.html&lt;/a&gt;. Make sure to read the &lt;a href=&quot;https://www.backblaze.com/b2/cloud-storage-pricing.html&quot;&gt;pricing details&lt;/a&gt; and your &lt;a href=&quot;https://secure.backblaze.com/b2_caps_alerts.htm&quot;&gt;usage statistic&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rclone config&lt;/code&gt; to configure B2 object storage. Follow this guide: &lt;a href=&quot;https://rclone.org/b2/&quot;&gt;https://rclone.org/b2/&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/posts/2021-05-16-Encrypt_and_backup_files_to_object_storage/2021-05-16-22-04-41.png&quot; alt=&quot;rclone config&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Go to Blackblaze B2 website and click on &lt;strong&gt;App keys&lt;/strong&gt; and generate a new set of keys for rclone.
&lt;img src=&quot;/assets/posts/2021-05-16-Encrypt_and_backup_files_to_object_storage/2021-05-16-22-07-10.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Add a new Application Key and copy the key ID and set it up in rclone.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/posts/2021-05-16-Encrypt_and_backup_files_to_object_storage/2021-05-16-22-07-48.png&quot; alt=&quot;&quot; /&gt;
&lt;img src=&quot;/assets/posts/2021-05-16-Encrypt_and_backup_files_to_object_storage/2021-05-16-22-34-18.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The name of the remote is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;b2-backup&lt;/code&gt;. I can use this name to connect with the Blackblaze server and perform operations like &lt;em&gt;sync&lt;/em&gt;, &lt;em&gt;dir list&lt;/em&gt;, etc.&lt;/p&gt;

&lt;p&gt;Create a new bucket using the following command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rclone &lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;b2-backup:photo-bucket
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Make sure to use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-&lt;/code&gt; instead of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_&lt;/code&gt; for the bucket name.&lt;/p&gt;

&lt;h4 id=&quot;create-a-folder-to-store-encrypted-files&quot;&gt;Create a folder to store encrypted files&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;backup-crypt
gocryptfs &lt;span class=&quot;nt&quot;&gt;-init&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-plaintextnames&lt;/span&gt; backup-crypt

&lt;span class=&quot;c&quot;&gt;# -plaintextnames : Do not encrypt the names of the files and folder&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#                   this helps when we are trying to recover lost files&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#                   Skip this option if you wish to hide the names of files&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Make sure to store the keys properly&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;mount-the-encrypted-files&quot;&gt;Mount the encrypted files&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;private
gocryptfs backup-crypt private
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Copy and paste files in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;private&lt;/code&gt; directory and the encrypted counter part will be reflected in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backup-crypt&lt;/code&gt; directory.&lt;/p&gt;

&lt;h4 id=&quot;sync-encrypted-files&quot;&gt;Sync encrypted files&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rclone &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--progress&lt;/span&gt; backup-crypt/ b2-backup:photo-bucket
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;unmount-the-private-directory-and-stay-safe-&quot;&gt;Unmount the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;private&lt;/code&gt; directory and stay safe üîí&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;fusermount &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; private
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Just make sure that you keep eye on the free limits. You can try to do a small sync everyday to save money on the transfer cost.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/posts/2021-05-16-Encrypt_and_backup_files_to_object_storage/2021-05-16-23-17-53.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;https://defuse.ca/downloads/audits/gocryptfs-cryptography-design-audit.pdf&quot;&gt;Gocryptfs security audit&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</content><author><name>Nitish Jadia</name><email>nitish@jadia.dev</email></author><category term="Linux" /><summary type="html">I feel that cloud backups are expensive, look at Dropbox, Google Drive, OneDrive, etc. BlackBlaze B2, seems to be a good for long term backups where you upload and forget, download only when we are required. It‚Äôs important to have your personal files encrypted when stored on the cloud, you never know about another iCloud hack.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jadia.dev/assets/social-devops-python-preview.png" /><media:content medium="image" url="https://jadia.dev/assets/social-devops-python-preview.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Get notification when laptop fan turns on</title><link href="https://jadia.dev/2020/12/15/python-fan-speed" rel="alternate" type="text/html" title="Get notification when laptop fan turns on" /><published>2020-12-15T15:50:00+00:00</published><updated>2020-12-15T15:50:00+00:00</updated><id>https://jadia.dev/2020/12/15/python-fan-speed</id><content type="html" xml:base="https://jadia.dev/2020/12/15/python-fan-speed">&lt;p&gt;I have a habit of putting my ultrabook on bed (vents are blocked) because the fans rarely start. But when it does I make sure to give enough room for fans to work.&lt;/p&gt;

&lt;p&gt;Below is a script I made to get notification on Ubuntu when fan starts. The script checks the fan status every few seconds and notifies the user if fan is running and goes to sleep for 5min.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
pip &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;psutil

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c1&quot;&gt;#!/usr/bin/env python3
&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;psutil&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;os&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;time&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sleep&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;logging&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;datetime&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dt&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;## Logging
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;logfile_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;datetime&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strftime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'fan_status_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;Y_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;m_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;d.log'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'/home/nitish/cron'&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;logfile_path&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'logs'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logfile_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;logging&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;basicConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logfile_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;filemode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'a'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                            &lt;span class=&quot;nb&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%(pathname)&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s, &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%(asctime)&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s, &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%(levelname)&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%(message)&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;s'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;datefmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;H:&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;M:&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;S'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                            &lt;span class=&quot;n&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logging&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DEBUG&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;logging&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getLogger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'fan_speed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;


&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Process started.&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;fan_running&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;fan_speed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psutil&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sensors_fans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()[&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'dell_smm'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# output: {'dell_smm': [sfan(label='', current=0)]}
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;debug&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'fan_speed: {fan_speed}'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fan_speed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fan_running&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Fan started running! Sleeping for 5min.&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'notify-send &quot;Fan started! {fan_speed} RPM&quot; -t 20000 -u critical'&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;fan_running&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;sleep_time&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# seconds
&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fan_speed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fan_running&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Fan still running! Sleeping for 5min.&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'notify-send &quot;Fan speed: {fan_speed} RPM&quot; -t 10000 -u normal'&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;sleep_time&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fan_running&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;'notify-send &quot;Fan stopped!&quot; -t 20000 -u low'&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;fan_running&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;False&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;None&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;# log.info(&quot;Fan not running&quot;)
&lt;/span&gt;            &lt;span class=&quot;n&quot;&gt;sleep_time&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;system&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sleep_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;except&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;exception&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Something went wrong.&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this script won‚Äôt be able to show the notification because of how &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;notify-send&lt;/code&gt; works.&lt;/p&gt;

&lt;p&gt;If you are using Ubuntu 20.04(Gnome) in GUI mode then you can go to &lt;strong&gt;Start up applications&lt;/strong&gt; and add your script over there.&lt;/p&gt;

&lt;p&gt;Since, I‚Äôm using i3wm (another window manager) I had to find a workaround for the script to run in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;crontab&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Adding &lt;strong&gt;target DISPLAY&lt;/strong&gt; to crontab helps.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;#Check the value of DISPLAY var&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$DISPLAY&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# output: :0&lt;/span&gt;
crontab &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I will add the following lines in the crontab.&lt;/p&gt;

&lt;div class=&quot;language-vim highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
DISPLAY&lt;span class=&quot;p&quot;&gt;=:&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
@reboot bash &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/home/nitish/cron/fan_status.py&quot;&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cheers! :beers:&lt;/p&gt;</content><author><name>Nitish Jadia</name><email>nitish@jadia.dev</email></author><category term="Python" /><summary type="html">I have a habit of putting my ultrabook on bed (vents are blocked) because the fans rarely start. But when it does I make sure to give enough room for fans to work.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jadia.dev/assets/social-devops-python-preview.png" /><media:content medium="image" url="https://jadia.dev/assets/social-devops-python-preview.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Connecting Google Service Account with Kubernetes Service Account</title><link href="https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account" rel="alternate" type="text/html" title="Connecting Google Service Account with Kubernetes Service Account" /><published>2020-09-10T14:52:00+00:00</published><updated>2020-09-10T14:52:00+00:00</updated><id>https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account</id><content type="html" xml:base="https://jadia.dev/2020/09/10/connecting-google-service-account-with-kubernetes-service-account">&lt;h2 id=&quot;3-ways-to-access-a-google-cloud-resource&quot;&gt;3 ways to access a Google Cloud Resource:&lt;/h2&gt;

&lt;p&gt;Your containers and Pods might need access to other resources in Google Cloud. There are three ways to do this.&lt;/p&gt;

&lt;p&gt;Below is a part extracted from the &lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/concepts/security-overview#giving_pods_access_to_resources&quot;&gt;Google Docs&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;h3 id=&quot;workload-identity-recommended&quot;&gt;&lt;strong&gt;Workload Identity (recommended)&lt;/strong&gt;&lt;/h3&gt;

  &lt;p&gt;The simplest and most secure way to authorize Pods to access Google Cloud resources is with¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity&quot;&gt;Workload Identity&lt;/a&gt;. Workload identity allows a Kubernetes service account to run as a¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity&quot;&gt;Google Cloud service account&lt;/a&gt;. Pods that run as the Kubernetes service account have the permissions of the Google Cloud service account.&lt;/p&gt;

  &lt;p&gt;Workload Identity can be used with¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods&quot;&gt;GKE Sandbox&lt;/a&gt;.&lt;/p&gt;

  &lt;h3 id=&quot;node-service-account&quot;&gt;&lt;strong&gt;Node Service Account&lt;/strong&gt;&lt;/h3&gt;

  &lt;p&gt;Your Pods can also authenticate to Google Cloud using the Kubernetes clusters‚Äô¬†&lt;a href=&quot;https://cloud.google.com/compute/docs/access/service-accounts&quot;&gt;service account&lt;/a&gt;¬†credentials from metadata. However, these credentials can be reached by any Pod running in the cluster if Workload Identity is not enabled. Create and configure a custom service account that has the¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster#use_least_privilege_sa&quot;&gt;minimum IAM roles&lt;/a&gt;¬†that are required by all the Pods running in the cluster.&lt;/p&gt;

  &lt;p&gt;This approach is not compatible with¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/sandbox-pods&quot;&gt;GKE Sandbox&lt;/a&gt;¬†because GKE Sandbox blocks access to the metadata server.&lt;/p&gt;

  &lt;h3 id=&quot;service-account-json-key&quot;&gt;&lt;strong&gt;Service Account JSON key&lt;/strong&gt;&lt;/h3&gt;

  &lt;p&gt;A third way to grant credentials for Google Cloud resources to applications is to manually use the¬†&lt;a href=&quot;https://cloud.google.com/iam/docs/creating-managing-service-account-keys&quot;&gt;service account‚Äôs key&lt;/a&gt;. This approach is strongly discouraged because of the difficulty of securely managing account keys.&lt;/p&gt;

  &lt;p&gt;You should use¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/tutorials/authenticating-to-cloud-platform&quot;&gt;application-specific Google Cloud service accounts to provide credentials&lt;/a&gt;¬†so that applications have the minimal necessary permissions. Each service account is assigned only the IAM roles that are needed for its paired application to operate successfully. Keeping the service account application-specific makes it easier to revoke its access in the case of a compromise without affecting other applications. Once you have assigned your service account the correct IAM roles, you can create a JSON service account key, and then mount that into your Pod using a Kubernetes¬†&lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/concepts/secret&quot;&gt;Secret&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;connecting-google-service-account-with-kubernetes-service-account&quot;&gt;Connecting Google service account with Kubernetes service account&lt;/h2&gt;

&lt;p&gt;This requires Workload identity to work.&lt;/p&gt;

&lt;h1 id=&quot;pre-requisites&quot;&gt;Pre-requisites:&lt;/h1&gt;

&lt;ol&gt;
  &lt;li&gt;Google service account with roles required by the application.&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;conditions&quot;&gt;Conditions:&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;The cluster MUST have workload identity enabled&lt;/li&gt;
  &lt;li&gt;The node pool‚Äôs &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;workload-metadata&lt;/code&gt; MUST be set as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GKE_METADATA&lt;/code&gt; instead of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;GCE_METADATA&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;A binding between the GSA(Google service account) and KSA(Kubernetes service account) MUST exist&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;enable-workload-identity-in-the-gke-cluster&quot;&gt;Enable workload identity in the GKE cluster&lt;/h2&gt;

&lt;p&gt;Source: &lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity&quot;&gt;Workload Identity | Kubernetes Engine Documentation | Google Cloud&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;new-cluster&quot;&gt;&lt;strong&gt;New Cluster:&lt;/strong&gt;&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;PROJECT_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;jadia-project
&lt;span class=&quot;nv&quot;&gt;CLUSTER_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ptdevops

gcloud container clusters create &lt;span class=&quot;nv&quot;&gt;$CLUSTER_NAME&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--release-channel&lt;/span&gt; regular &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--workload-pool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PROJECT&lt;/span&gt;.svc.id.goog
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;existing-cluster&quot;&gt;&lt;strong&gt;Existing cluster&lt;/strong&gt;:&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;PROJECT_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;jadia-project
&lt;span class=&quot;nv&quot;&gt;CLUSTER_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;playops

gcloud container clusters update &lt;span class=&quot;nv&quot;&gt;$CLUSTER_NAME&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--workload-pool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PROJECT_ID&lt;/span&gt;.svc.id.goog
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Source: &lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_existing_cluster&quot;&gt;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_existing_cluster&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;or you can go and edit the cluster from web interface and enable &lt;em&gt;workload identity&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Enable workload identity in the node-pool:&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Do this to all the node pools in the cluster&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;CLUSTER_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;playops
&lt;span class=&quot;nv&quot;&gt;NODE_POOL_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;standard-pool-1

gcloud container node-pools update &lt;span class=&quot;nv&quot;&gt;$NODE_POOL_NAME&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--cluster&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CLUSTER_NAME&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--workload-metadata&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;GKE_METADATA
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;source: &lt;a href=&quot;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#option_1_node_pool_modification&quot;&gt;https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#option_1_node_pool_modification&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;create-a-binding-between-the-gsa-and-ksa&quot;&gt;Create a binding between the GSA and KSA&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Create a GSA with the required roles.&lt;/li&gt;
  &lt;li&gt;Create KSA  with annotation about the GSA&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;NAMESPACE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default
&lt;span class=&quot;nv&quot;&gt;GCLOUD_SERVICE_ACCOUNT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;test-gsa
&lt;span class=&quot;nv&quot;&gt;PROJECT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;playops
&lt;span class=&quot;nv&quot;&gt;KUBE_SERVICE_ACCOUNT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;k8s-service-account

kubectl annotate serviceaccount &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--namespace&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$NAMESPACE&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$KUBE_SERVICE_ACCOUNT_NAME&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    iam.gke.io/gcp-service-account&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$GCLOUD_SERVICE_ACCOUNT_NAME&lt;/span&gt;@&lt;span class=&quot;nv&quot;&gt;$PROJECT_NAME&lt;/span&gt;.iam.gserviceaccount.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or just add annotation as:&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ServiceAccount&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;annotations&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;iam.gke.io/gcp-service-account&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-gsa@playops.iam.gserviceaccount.com&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;k8s-service-account&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;Create binding&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;NAMESPACE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default
&lt;span class=&quot;nv&quot;&gt;KSA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;k8s-service-account
&lt;span class=&quot;nv&quot;&gt;PROJECT_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;playops
&lt;span class=&quot;nv&quot;&gt;GSA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;test-gsa@&lt;span class=&quot;nv&quot;&gt;$NAMESPACE&lt;/span&gt;.iam.gserviceaccount.com

gcloud iam service-accounts add-iam-policy-binding &lt;span class=&quot;se&quot;&gt;\ &lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--role&lt;/span&gt; roles/iam.workloadIdentityUser &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--member&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;serviceAccount:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PROJECT_NAME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.svc.id.goog[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$NAMESPACE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$KSA&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;]&quot;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$GSA&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;test-if-workload-identity-is-working-or-not&quot;&gt;Test if workload identity is working or not&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl run &lt;span class=&quot;nt&quot;&gt;-it&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--image&lt;/span&gt; google/cloud-sdk:slim &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--serviceaccount&lt;/span&gt; k8s-service-account &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--namespace&lt;/span&gt; default workload-identity-test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Inside the pod&lt;/span&gt;
gcloud auth list

&lt;span class=&quot;c&quot;&gt;#OUTPUT&amp;gt;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#root@workload-identity-test:/# gcloud auth list&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#              Credentialed Accounts&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ACTIVE  ACCOUNT&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#*       test-gsa@playops.iam.gserviceaccount.com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;references&quot;&gt;References&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://medium.com/google-cloud/updating-google-container-engine-vm-scopes-with-zero-downtime-50bff87e5f80&quot;&gt;Dinesh, Sandeep. ‚ÄúUpdating Google Kubernetes Engine VM Scopes with Zero Downtime.‚Äù Medium. Last modified February 6, 2018. Accessed September 10, 2020.&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://dzone.com/articles/enabling-gke-workload-identity&quot;&gt;‚ÄúEnabling GKE Workload Identity - DZone Cloud.‚Äù Dzone.Com. Accessed September 10, 2020&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=2HmDZXbfA80&quot;&gt;‚ÄúNode Management in GKE (Cloud Next ‚Äô19) - YouTube.‚Äù Accessed September 10, 2020&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;</content><author><name>Nitish Jadia</name><email>nitish@jadia.dev</email></author><category term="Kubernetes" /><summary type="html">3 ways to access a Google Cloud Resource: Your containers and Pods might need access to other resources in Google Cloud. There are three ways to do this.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jadia.dev/assets/social-devops-python-preview.png" /><media:content medium="image" url="https://jadia.dev/assets/social-devops-python-preview.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Using GitLab CI/CD to build and store container images</title><link href="https://jadia.dev/2020/08/25/using-gitlab-ci-cd-to-build-and-store-container-images" rel="alternate" type="text/html" title="Using GitLab CI/CD to build and store container images" /><published>2020-08-25T11:36:00+00:00</published><updated>2020-08-25T11:36:00+00:00</updated><id>https://jadia.dev/2020/08/25/using-gitlab-ci-cd-to-build-and-store-container-images</id><content type="html" xml:base="https://jadia.dev/2020/08/25/using-gitlab-ci-cd-to-build-and-store-container-images">&lt;p&gt;Often building container images consume a lot of bandwidth and back at home I don‚Äôt have a good internet connection to build images again and again.&lt;/p&gt;

&lt;p&gt;Also, there are times when I have
to, again and again, push the container images to Docker hub in a short period. I felt that they tend to slow down the upload speeds when I do this.
(I‚Äôm not sure how accurate is this observation.)&lt;/p&gt;

&lt;p&gt;Instead of Docker Hub to host the repository and building images on my local machine, I thought of using GitLab‚Äôs CI/CD to do the job.&lt;/p&gt;

&lt;h3 id=&quot;setting-up-repository-to-build-and-store-container-images&quot;&gt;Setting up repository to build and store container images&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Create a new &lt;em&gt;Project&lt;/em&gt; in GitLab. &lt;br /&gt;
 &lt;img src=&quot;/assets/posts/gitlab_ci_cd/create_project.png&quot; alt=&quot;Create Project in GitLab&quot; /&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Create a new file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Docker.gitlab-ci.yml&lt;/code&gt; in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;master&lt;/code&gt; branch as a template
 to use when we will use CI/CD pipeline to build the docker images.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;#Docker.gitlab-ci.yml&lt;/span&gt;

&lt;span class=&quot;s&quot;&gt;build:image:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;docker:stable&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;docker:dind&lt;/span&gt;

  &lt;span class=&quot;na&quot;&gt;variables&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;DOCKER_HOST&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;tcp://docker:2375&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;DOCKER_DRIVER&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;overlay2&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;IMAGE_NAME&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hello&lt;/span&gt;                           &lt;span class=&quot;c1&quot;&gt;# CHANGE IMAGE NAME&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;TAG&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;latest&lt;/span&gt;                                 &lt;span class=&quot;c1&quot;&gt;# EDIT TAG&lt;/span&gt;

  &lt;span class=&quot;na&quot;&gt;before_script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY&lt;/span&gt;

  &lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;docker build --pull -t $CI_REGISTRY_IMAGE/$IMAGE_NAME:$TAG .&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;docker push $CI_REGISTRY_IMAGE/$IMAGE_NAME:$TAG&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;building-a-container-image&quot;&gt;Building a container Image&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;Create a new branch from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;master&lt;/code&gt;.
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; git checkout &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; flask-app
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Add required files and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; to the branch.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Docker.gitlab-ci.yml&lt;/code&gt; template to create a new
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.gitlab-ci.yml&lt;/code&gt; file which will build the image. &lt;br /&gt;
  &lt;strong&gt;Remember:&lt;/strong&gt; Change the variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;IMAGE_NAME&lt;/code&gt; in the yaml file with the name
  of the image.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;Push the changes and naviage to &lt;strong&gt;CI/CD&lt;/strong&gt; and &lt;strong&gt;Container Registry&lt;/strong&gt; section
 of the project to see the image build and stored images.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;I use &lt;a href=&quot;https://gitlab.com/nitishjadia/build&quot;&gt;this GitLab repository&lt;/a&gt; to do the job.
You can clone it and get started without doing the above steps.&lt;/p&gt;</content><author><name>Nitish Jadia</name><email>nitish@jadia.dev</email></author><category term="CI/CD" /><summary type="html">Often building container images consume a lot of bandwidth and back at home I don‚Äôt have a good internet connection to build images again and again.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jadia.dev/assets/social-devops-python-preview.png" /><media:content medium="image" url="https://jadia.dev/assets/social-devops-python-preview.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Bitcoin Whitepaper</title><link href="https://jadia.dev/2020/07/08/bitcoin-whitepaper" rel="alternate" type="text/html" title="Bitcoin Whitepaper" /><published>2020-07-08T15:12:00+00:00</published><updated>2020-07-08T15:12:00+00:00</updated><id>https://jadia.dev/2020/07/08/bitcoin-whitepaper</id><content type="html" xml:base="https://jadia.dev/2020/07/08/bitcoin-whitepaper">&lt;h2 id=&quot;bitcoin-a-peer-to-peer-electronic-cash-system&quot;&gt;Bitcoin: A Peer-to-Peer Electronic Cash System&lt;/h2&gt;

&lt;h3 id=&quot;introduction&quot;&gt;Introduction&lt;/h3&gt;

&lt;p&gt;Satoshi Nakamoto proposes an overarching solution to double spending problem using a peer-to-peer network which supports an electronic payment system based on cryptographic proof instead of trust unlike the the method used by financial institutions.
A computational proof of the chronological order of transaction is generated by p2p distributed timestamp server. The reversal of transaction will be computationally impractical unless more than 50% of nodes are not intending to attack the network.&lt;/p&gt;

&lt;h3 id=&quot;transactions&quot;&gt;Transactions&lt;/h3&gt;

&lt;p&gt;Each transaction is clubbed with the hash of the previous transaction and public key of next owner then signed by the person making this transaction. This forms a chain of transactions. This chain of digital signatures are called electronic coin.
Solving double spending problem without any mediating third-party requires a node to be aware of all the transactions.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;The transactions must be publicly announced.&lt;/li&gt;
  &lt;li&gt;All participants must agree on a single chronological order of all transactions.&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;timestamp-server&quot;&gt;Timestamp Server&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/assets/posts/bitcoin-whitepaper/timestamp.png&quot; alt=&quot;Bitcoin timestamp&quot; /&gt;
Timestamp server generates a hash of the current block, it also includes timestamp of previous block, hence forming a chain.&lt;/p&gt;

&lt;h3 id=&quot;proof-of-work&quot;&gt;Proof of work&lt;/h3&gt;

&lt;p&gt;The Proof-of-Work[PoW] involves guessing a nounce value which can generate a hash which starts with a required amount on zero bits. The block cannot be changed without redoing the work. This implies that to modify a past block, an attacker would have to redo the PoW for that block and all the blocks after it. Average work required is exponential in the number of zero bits required. PoW difficulty increases if blocks are being generated too fast.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Y=H ( X || k )&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;There exist no efficient algorithm to find value of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;k&lt;/code&gt;(nounce).&lt;/p&gt;

&lt;h3 id=&quot;network&quot;&gt;Network&lt;/h3&gt;

&lt;p&gt;New transactions are broadcasted to all nodes, all the nodes collect new transactions into a block and try to find PoW for that block. When PoW is found, the block is broadcasted to all the nodes. The block is accepted by the nodes if all the transactions in the block are valid and not already spent. The hash of the accepted block is considered as previous hash.
Nodes always consider longest chain to be the correct one and work on extending it.&lt;/p&gt;

&lt;h3 id=&quot;incentive&quot;&gt;Incentive&lt;/h3&gt;

&lt;p&gt;Just like gold miners adding gold to the circulation, the bitcoin miners too get paid as block reward when they are successful in their PoW, that means, with each new block, the bitcoin in the economy increases.The incentive can also be funded with transaction fees.
The first transaction in a block is a special transaction that starts a new coin owned by the creator of the block.&lt;/p&gt;

&lt;h3 id=&quot;saving-disk-space&quot;&gt;Saving disk space&lt;/h3&gt;

&lt;p&gt;Instead of storing whole Merkle Tree, we can stubbing off the branches off the tree and keeping the block header with no transactions. The hash value in the block header keeps the integrity of all its sub-branches and transactions.&lt;/p&gt;

&lt;h3 id=&quot;payment-verification&quot;&gt;Payment Verification&lt;/h3&gt;

&lt;p&gt;A transaction can be verified by a user without running a full node network. It just has to keep a copy of block headers of the longest PoW chain. The user cannot check for validity of the transaction by himself because he won‚Äôt be having all the transactions with himself. He can just see that the transaction is a part of longest chain and this confirms that the transaction is valid. Verification requires executing only single hash.&lt;/p&gt;

&lt;h3 id=&quot;privacy&quot;&gt;Privacy&lt;/h3&gt;

&lt;p&gt;Privacy can be maintained by keeping public keys anonymous. It is advisable to use a new key pair for each transaction to keep them from being linked to a common owner.&lt;/p&gt;

&lt;h3 id=&quot;security&quot;&gt;Security&lt;/h3&gt;

&lt;p&gt;An attack can only try to change one of his own transactions to take back money he recently spent. The probability of a survival of a dishonest chain is fairly low.&lt;/p&gt;</content><author><name>Nitish Jadia</name><email>nitish@jadia.dev</email></author><category term="Blockchain" /><category term="Whitepapers" /><summary type="html">Bitcoin: A Peer-to-Peer Electronic Cash System</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jadia.dev/assets/social-devops-python-preview.png" /><media:content medium="image" url="https://jadia.dev/assets/social-devops-python-preview.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>